import xml.etree.ElementTree as ET
from collections import defaultdict

def get_dashboard_hierarchy(path):
    tree = ET.parse(path)
    root = tree.getroot()
    dashboards = defaultdict(set)  # use set to avoid duplicates

    for dashboard in root.findall(".//dashboard"):
        dash_name = (
            dashboard.attrib.get("caption")
            or dashboard.attrib.get("name")
            or "Unnamed Dashboard"
        )

        for zone in dashboard.findall(".//zone"):
            ws_name = zone.attrib.get("name")
            if not ws_name:
                continue

            worksheets = root.findall(f".//worksheet[@name='{ws_name}']")
            for ws in worksheets:
                for col in ws.findall(".//column"):
                    # Extract KPI name
                    kpi_name = col.attrib.get("caption") or col.attrib.get("name")

                    # Skip blank or None
                    if not kpi_name or kpi_name.strip() == "":
                        continue

                    # Include formula if calculated field exists
                    calc = col.find("calculation")
                    if calc is not None:
                        formula = calc.attrib.get("formula")
                        if formula:
                            kpi_name = f"{kpi_name} ({formula})"

                    dashboards[dash_name].add(kpi_name)

    # Convert sets â†’ sorted lists for readability
    return {dash: sorted(list(kpis)) for dash, kpis in dashboards.items()}